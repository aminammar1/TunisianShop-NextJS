name: Monthly Dependency Update

on:
  schedule:
    - cron: '0 9 1 * *'
  workflow_dispatch:

jobs:
  update-backend-dependencies:
    name: Update Backend Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: Install dependencies
        working-directory: ./server
        run: npm ci

      - name: Check for outdated packages
        working-directory: ./server
        run: |
          echo "Current outdated packages:"
          npm outdated || true

      - name: Update dependencies
        working-directory: ./server
        run: |
          npm install -g npm-check-updates
          npx ncu -u --target minor
          npm install

      - name: Check for security vulnerabilities
        working-directory: ./server
        run: npm audit fix --force || true

      - name: Run tests after update
        working-directory: ./server
        run: |
          if grep -q '"test"' package.json; then
            npm test || echo "Tests failed - manual review needed"
          else
            echo "No tests configured"
          fi

      - name: Check for breaking changes
        working-directory: ./server
        run: |
          timeout 30s npm start || echo "Application may have breaking changes"

      - name: Create Pull Request for Backend
        if: success()
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(server): update dependencies'
          title: 'Monthly Backend Dependencies Update'
          body: |
            ## Backend Dependencies Update

            This PR updates backend dependencies to their latest compatible versions.

            ### Changes Made:
            - Updated npm packages to latest versions
            - Applied security fixes where available
            - Ran automated tests to verify compatibility

            ### Manual Review Required:
            - [ ] Test core API functionality
            - [ ] Verify database connections
            - [ ] Check authentication flows
            - [ ] Validate file upload features
            - [ ] Test payment integration

            **Note**: Please review and test thoroughly before merging.
          branch: chore/update-backend-dependencies
          delete-branch: true

  update-frontend-dependencies:
    name: Update Frontend Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: Install dependencies
        working-directory: ./client
        run: npm ci

      - name: Check for outdated packages
        working-directory: ./client
        run: |
          echo "Current outdated packages:"
          npm outdated || true

      - name: Update dependencies
        working-directory: ./client
        run: |
          npm install -g npm-check-updates
          npx ncu -u --target minor
          npm install

      - name: Check for security vulnerabilities
        working-directory: ./client
        run: npm audit fix --force || true

      - name: Build application after update
        working-directory: ./client
        run: |
          npm run build || echo "Build failed - manual review needed"

      - name: Run tests after update
        working-directory: ./client
        run: |
          if grep -q '"test"' package.json; then
            npm test || echo "Tests failed - manual review needed"
          else
            echo "No tests configured"
          fi

      - name: Create Pull Request for Frontend
        if: success()
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(client): update dependencies'
          title: 'Monthly Frontend Dependencies Update'
          body: |
            ## Frontend Dependencies Update

            This PR updates frontend dependencies to their latest compatible versions.

            ### Changes Made:
            - Updated npm packages to latest versions
            - Applied security fixes where available
            - Verified build process still works
            - Ran automated tests where available

            ### Manual Review Required:
            - [ ] Test user interface functionality
            - [ ] Verify responsive design
            - [ ] Check authentication flows
            - [ ] Test shopping cart features
            - [ ] Validate payment forms
            - [ ] Test on different browsers

            **Note**: Please review and test thoroughly before merging.
          branch: chore/update-frontend-dependencies
          delete-branch: true
